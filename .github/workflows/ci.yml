name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: install
        id: install
        run: |
          set +e
          npm ci
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code
        continue-on-error: true

      - name: lint
        id: lint
        run: |
          set +e
          npm run lint
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code
        continue-on-error: true

      - name: test
        id: test
        run: |
          set +e
          npm test
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code
        continue-on-error: true

      - name: ingest
        id: ingest
        run: |
          set +e
          npm run ingest
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code
        continue-on-error: true

      - name: build
        id: build
        run: |
          set +e
          npm run build
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code
        continue-on-error: true

      - name: validate
        id: validate
        run: |
          set +e
          npm run validate
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code
        continue-on-error: true

      - name: generate summary
        if: always()
        run: |
          STATUS_INSTALL="${{ steps.install.outcome }}"
          STATUS_LINT="${{ steps.lint.outcome }}"
          STATUS_TEST="${{ steps.test.outcome }}"
          STATUS_INGEST="${{ steps.ingest.outcome }}"
          STATUS_BUILD="${{ steps.build.outcome }}"
          STATUS_VALIDATE="${{ steps.validate.outcome }}"

          EXIT_INSTALL="${{ steps.install.outputs.exit_code }}"
          EXIT_LINT="${{ steps.lint.outputs.exit_code }}"
          EXIT_TEST="${{ steps.test.outputs.exit_code }}"
          EXIT_INGEST="${{ steps.ingest.outputs.exit_code }}"
          EXIT_BUILD="${{ steps.build.outputs.exit_code }}"
          EXIT_VALIDATE="${{ steps.validate.outputs.exit_code }}"

          [ -z "$EXIT_INSTALL" ] && EXIT_INSTALL="n/a"
          [ -z "$EXIT_LINT" ] && EXIT_LINT="n/a"
          [ -z "$EXIT_TEST" ] && EXIT_TEST="n/a"
          [ -z "$EXIT_INGEST" ] && EXIT_INGEST="n/a"
          [ -z "$EXIT_BUILD" ] && EXIT_BUILD="n/a"
          [ -z "$EXIT_VALIDATE" ] && EXIT_VALIDATE="n/a"

          icon() { [ "$1" = "success" ] && echo "✅" || echo "❌"; }

          SUMMARY_FILE="ci-summary.md"
          {
            echo "# CI Run Summary"
            echo ""
            echo "| Step | Command | Status | Exit code |"
            echo "|------|---------|--------|-----------|"
            echo "| install  | \`npm ci\` | $(icon "$STATUS_INSTALL") $STATUS_INSTALL | $EXIT_INSTALL |"
            echo "| lint     | \`npm run lint\` | $(icon "$STATUS_LINT") $STATUS_LINT | $EXIT_LINT |"
            echo "| test     | \`npm test\` | $(icon "$STATUS_TEST") $STATUS_TEST | $EXIT_TEST |"
            echo "| ingest   | \`npm run ingest\` | $(icon "$STATUS_INGEST") $STATUS_INGEST | $EXIT_INGEST |"
            echo "| build    | \`npm run build\` | $(icon "$STATUS_BUILD") $STATUS_BUILD | $EXIT_BUILD |"
            echo "| validate | \`npm run validate\` | $(icon "$STATUS_VALIDATE") $STATUS_VALIDATE | $EXIT_VALIDATE |"
            echo ""
            if [ "$STATUS_INSTALL" != "success" ] || [ "$STATUS_LINT" != "success" ] || [ "$STATUS_TEST" != "success" ] || \
               [ "$STATUS_INGEST" != "success" ] || [ "$STATUS_BUILD" != "success" ] || \
               [ "$STATUS_VALIDATE" != "success" ]; then
              echo "## Remediation Hints"
              echo ""
              [ "$STATUS_INSTALL"  != "success" ] && echo "- **install failed**: run \`npm ci\` locally; check your Node.js version and network access."
              [ "$STATUS_LINT"     != "success" ] && echo "- **lint failed**: run \`npm run lint\` locally and fix TypeScript errors."
              [ "$STATUS_TEST"     != "success" ] && echo "- **test failed**: run \`npm test\` locally; check for regressions in parsers, normalization, or SVG output."
              [ "$STATUS_INGEST"   != "success" ] && echo "- **ingest failed**: run \`npm run ingest\` locally; verify cached HTML under \`data/sources/\` is present (\`npm run audit-cache\`)."
              [ "$STATUS_BUILD"    != "success" ] && echo "- **build failed**: run \`npm run build\` locally; check docs/SVG generator errors."
              [ "$STATUS_VALIDATE" != "success" ] && echo "- **validate failed**: run \`npm run validate\` locally; check \`chords.schema.json\` compliance and provenance."
            fi
          } > "$SUMMARY_FILE"

          cat "$SUMMARY_FILE" >> "$GITHUB_STEP_SUMMARY"

      - name: upload summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: ci-summary.md
          retention-days: 7

      - name: fail if any step failed
        if: |
          steps.install.outcome != 'success' ||
          steps.lint.outcome != 'success' ||
          steps.test.outcome != 'success' ||
          steps.ingest.outcome != 'success' ||
          steps.build.outcome != 'success' ||
          steps.validate.outcome != 'success'
        run: |
          echo "One or more CI steps failed. See ci-summary.md artifact for details."
          exit 1
